{% extends "base.html" %}
{% block content %}
    <div class="container mx-auto py-6 px-4 sm:px-6 lg:px-8">
        <h2 class="text-3xl font-bold mb-6 text-gray-800">Mijozlar ro'yxati</h2>

        <form id="filterForm" method="GET" action="{% url 'customer_list' %}" class="mb-6">
            <div class="flex flex-col md:flex-row md:space-x-4 space-y-4 md:space-y-0">

                <input type="text" id="searchInput" name="q" placeholder="Mijoz nomi qidiring..."
                       value="{{ search_query }}"
                       class="flex-grow p-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">

                <div class="flex flex-row space-x-4">
                    <select id="debtStatusSelect" name="debt_status"
                            class="w-1/2 md:w-auto p-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">Holat: Barchasi</option>
                        <option value="has_debt" {% if debt_status == 'has_debt' %}selected{% endif %}>Qarzi borlar
                        </option>
                        <option value="no_debt" {% if debt_status == 'no_debt' %}selected{% endif %}>Qarzi yo'qlar
                        </option>
                    </select>

                    <select id="sortSelect" name="sort_by_debt"
                            class="w-1/2 md:w-auto p-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">Saralash...</option>
                        <option value="max_debt" {% if sort_by_debt == 'max_debt' %}selected{% endif %}>Eng ko'p qarz
                        </option>
                        <option value="min_debt" {% if sort_by_debt == 'min_debt' %}selected{% endif %}>Eng kam qarz
                        </option>
                        <option value="latest_debt" {% if sort_by_debt == 'latest_debt' %}selected{% endif %}>Oxirgi
                            qarz
                        </option>
                    </select>
                </div>

                <button type="button" id="resetButton"
                        class="p-3 px-6 bg-red-500 text-white rounded-lg shadow hover:bg-red-600 transition md:w-auto">
                    Filterni Tozalash
                </button>
            </div>
        </form>

        <div id="customerListContainer">

            <div id="customerList" class="space-y-3">
                {% for customer in customers %}
                    <a href="{% url 'customer_debt_list' customer.id %}"
                       class="block bg-white border border-gray-200 p-3 rounded-lg shadow-sm hover:shadow-lg transition duration-300 ease-in-out hover:border-blue-400">

                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center">
                            <div class="mb-2 sm:mb-0">
                                <p class="text-lg font-semibold text-gray-900 break-words">{{ customer.name }}</p>
                                <p class="text-sm text-gray-600 mt-1">
                                    Qarz: <span class="font-bold text-red-600">{{ customer.total_debt|default:"0" }} so'm</span>
                                </p>
                                {% if customer.last_debt_date %}
                                    <p class="text-xs text-gray-500">Oxirgi
                                        qarz: {{ customer.last_debt_date|date:"d M Y" }}</p>
                                {% endif %}
                            </div>

                            <div class="flex-shrink-0">
                                {% if customer.total_debt > 0 %}
                                    <span class="px-3 py-1 text-sm bg-yellow-100 text-yellow-800 rounded-full font-medium">Qarzi bor</span>
                                {% else %}
                                    <span class="px-3 py-1 text-sm bg-green-100 text-green-800 rounded-full font-medium">Qarzi yo'q</span>
                                {% endif %}
                            </div>
                        </div>
                    </a>
                {% empty %}
                    <p class="text-gray-500 text-center py-4">Filter bo'yicha mijozlar topilmadi.</p>
                {% endfor %}
            </div>

            <div class="mt-8">
                {% if page_obj.has_other_pages %}
                    <div class="flex justify-center mt-6 space-x-2 flex-wrap">
                        {% if page_obj.has_previous %}
                            <a href="?page=
                                    {{ page_obj.previous_page_number }}{% if request.GET.date %}&date={{ request.GET.date }}{% endif %}"
                               class="px-3 py-2 bg-gray-200 rounded hover:bg-gray-300">← Oldingi</a>
                        {% else %}
                            <span class="px-3 py-2 bg-gray-100 rounded text-gray-400 cursor-not-allowed">← Oldingi</span>
                        {% endif %}

                        {% for page_num in page_obj.paginator.page_range %}
                            {% if page_num == page_obj.number %}
                                <span class="px-3 py-2 bg-indigo-500 text-white rounded">{{ page_num }}</span>
                            {% elif page_num > page_obj.number|add:-3 and page_num < page_obj.number|add:3 %}
                                <a href="?page=
                                        {{ page_num }}{% if request.GET.date %}&date={{ request.GET.date }}{% endif %}"
                                   class="px-3 py-2 bg-gray-200 rounded hover:bg-gray-300">{{ page_num }}</a>
                            {% endif %}
                        {% endfor %}

                        {% if page_obj.has_next %}
                            <a href="?page=
                                    {{ page_obj.next_page_number }}{% if request.GET.date %}&date={{ request.GET.date }}{% endif %}"
                               class="px-3 py-2 bg-gray-200 rounded hover:bg-gray-300">Keyingi →</a>
                        {% else %}
                            <span class="px-3 py-2 bg-gray-100 rounded text-gray-400 cursor-not-allowed">Keyingi →</span>
                        {% endif %}
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    <script>
        const searchInput = document.getElementById('searchInput');
        const form = document.getElementById('filterForm');
        const customerListContainer = document.getElementById('customerListContainer');
        const resetButton = document.getElementById('resetButton');

        let debounceTimer;

        // 1. SELECT o'zgarishini kuzatish
        document.getElementById('debtStatusSelect').addEventListener('change', debouncedFetch);
        document.getElementById('sortSelect').addEventListener('change', debouncedFetch);

        // 2. Tozalash (Reset) funksiyasi
        resetButton.addEventListener('click', () => {
            // Barcha input va select qiymatlarini standart holatga qaytarish
            searchInput.value = '';
            document.getElementById('debtStatusSelect').value = '';
            document.getElementById('sortSelect').value = '';

            // Formani yuborish (barcha parametrlarsiz toza so'rov yuborish uchun)
            debouncedFetch();
        });

        // 3. AJAX so'rovini yuboruvchi funksiya (Debounce bilan)
        function debouncedFetch() {
            clearTimeout(debounceTimer);

            debounceTimer = setTimeout(() => {
                const formData = new FormData(form);
                const params = new URLSearchParams(formData).toString();

                // Faqat qiymati bor parametrlarni URL ga qo'shamiz (bo'sh qolganlarini tashlab yuborish)
                let filteredParams = new URLSearchParams();
                for (const [key, value] of formData.entries()) {
                    if (value) {
                        filteredParams.append(key, value);
                    }
                }

                const url = `{% url 'customer_list' %}?${filteredParams.toString()}`;
                window.history.pushState({}, '', url); // URL ni yangilash

                // Boshqa barcha filterlar ham AJAX orqali yangilanishi uchun
                fetch(url, {method: 'GET', headers: {'X-Requested-With': 'XMLHttpRequest'}})
                    .then(response => response.text())
                    .then(text => {
                        const parser = new DOMParser();
                        const doc = parser.parseFromString(text, 'text/html');
                        const newContainer = doc.getElementById('customerListContainer');

                        if (newContainer) {
                            customerListContainer.innerHTML = newContainer.innerHTML;
                        }
                    })
                    .catch(error => console.error('Qidiruvda xatolik:', error));

            }, 300);
        };

        // Qidiruv maydonida yozilganda AJAX chaqirish
        searchInput.addEventListener('input', debouncedFetch);
    </script>
{% endblock %}