{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="container mt-4">
    <h2 class="mb-3">üõí Yangi Savdo</h2>

    {% include "partials/messages.html" %}

    <form method="post">
        {% csrf_token %}
        <div class="row g-2 mb-3">
            <div class="col-md-6">
                <input type="text" name="barcode" placeholder="Barcode scan..." class="form-control" autofocus>
            </div>
            <div class="col-md-2">
                <input type="number" name="quantity" value="1" min="1" class="form-control">
            </div>
            <div class="col-md-4">
                <button type="submit" name="add_product" class="btn btn-primary w-100">‚ûï Qo‚Äòshish</button>
            </div>
        </div>

        <div class="table-responsive">
            <table class="table table-bordered text-center align-middle">
                <thead class="table-dark">
                    <tr>
                        <th>#</th>
                        <th>Mahsulot</th>
                        <th>Barcode</th>
                        <th>Soni</th>
                        <th>Narxi</th>
                        <th>Jami</th>
                        <th>‚ùå</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in items %}
                        <tr>
                            <td>{{ forloop.counter }}</td>
                            <td>{{ item.product.name }}</td>
                            <td>{{ item.product.barcode }}</td>
                            <td>{{ item.quantity }}</td>
                            <td>{{ item.price }}</td>
                            <td>{{ item.subtotal }}</td>
                            <td>
                                <button type="submit" name="remove_product" value="{{ item.id }}" class="btn btn-sm btn-danger">X</button>
                            </td>
                        </tr>
                    {% empty %}
                        <tr>
                            <td colspan="7" class="text-muted">üö´ Mahsulot qo‚Äòshilmagan</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <div class="d-flex gap-2 mb-3">
            <button type="submit" name="clear_sale" class="btn btn-warning flex-fill">üßπ Tozalash</button>
            <button type="submit" name="cancel_sale" class="btn btn-secondary flex-fill">‚ùå Bekor qilish</button>
        </div>

        <button type="button" class="btn btn-success w-100" data-bs-toggle="modal" data-bs-target="#finishModal">
            ‚úÖ Savdoni yakunlash
        </button>
    </form>
</div>

<!-- Modal -->
<div class="modal fade" id="finishModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <form method="post" action="{% url 'sales:finish_sale' sale.id %}" class="modal-content">
            {% csrf_token %}
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">üí∞ Savdoni yakunlash</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-2">
                    <label>Jami summa:</label>
                    <input type="text" class="form-control" value="{{ total }}" readonly>
                </div>
                <div class="mb-2">
                    <label>Qancha to‚Äòlandi:</label>
                    <input type="number" name="paid_amount" class="form-control" required>
                </div>
                <div class="mb-2">
                    <label>To‚Äòlov turi:</label>
                    <select name="payment_type" id="payment_type" class="form-control" required onchange="toggleCustomer()">
                        <option value="cash">Naqd</option>
                        <option value="card">Karta</option>
                        <option value="credit">Nasiya</option>
                    </select>
                </div>
                <div class="mb-2" id="customerDiv" style="display:none;">
                    <label>Mijoz ismi:</label>
                    <input type="text" name="customer_name" class="form-control">
                </div>
                <div class="mb-2">
                    <label>Qaytim:</label>
                    <input type="text" id="change" class="form-control" readonly>
                </div>
            </div>
            <div class="modal-footer">
                <button type="submit" class="btn btn-success w-100">‚úÖ Yakunlash</button>
            </div>
        </form>
    </div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
function toggleCustomer(){
    const paymentType = document.getElementById('payment_type').value;
    document.getElementById('customerDiv').style.display = paymentType === 'credit' ? 'block' : 'none';
}

document.addEventListener('DOMContentLoaded', function() {
    const paidInput = document.querySelector('[name="paid_amount"]');
    const changeInput = document.getElementById('change');
    const total = parseFloat("{{ total|default:0|floatformat:2 }}");

    paidInput.addEventListener('input', function(){
        const paid = parseFloat(this.value) || 0;
        changeInput.value = (paid - total).toFixed(2);
    });
});
</script>
{% endblock %}
