{% extends 'base.html' %}
{% block content %}
<div class="container mx-auto p-4 bg-gray-100 min-h-screen">

    <h1 class="text-3xl font-bold mb-6">Add Purchase</h1>

    <form method="post" id="purchase-form">
        {% csrf_token %}

        <div id="items">
            <div class="item flex gap-3 mb-4 items-end bg-white p-4 rounded shadow">
                <div class="flex-1">
                    <label class="block mb-1 font-medium text-gray-700">Product</label>
                    <select name="product" class="border rounded px-2 py-1 w-full product-select">
                        <option value="">Select Product</option>
                        {% for product in products %}
                        <option value="{{ product.id }}" data-price="{{ product.cost_price }}">{{ product.name }} - {{ product.cost_price|floatformat:0 }} UZS</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="w-24">
                    <label class="block mb-1 font-medium text-gray-700">Quantity</label>
                    <input type="number" name="quantity" value="1" min="1" class="border rounded px-2 py-1 w-full quantity-input">
                </div>

                <div class="w-32">
                    <label class="block mb-1 font-medium text-gray-700">Price (UZS)</label>
                    <input type="text" readonly class="border rounded px-2 py-1 w-full price-input bg-gray-100">
                </div>

                <div class="w-32">
                    <label class="block mb-1 font-medium text-gray-700">Total (UZS)</label>
                    <input type="text" readonly class="border rounded px-2 py-1 w-full total-input bg-gray-100">
                </div>

                <button type="button" class="remove-item bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600">Remove</button>
            </div>
        </div>

        <button type="button" id="add-item" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 mb-4">Add Item</button>

        <div class="mb-4 text-xl font-semibold">
            Grand Total: <span id="grand-total" class="text-green-600">0 UZS</span>
        </div>

        <button type="submit" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">Save Purchase</button>
    </form>
</div>
<script>
function updateItem(item){
    let select = item.querySelector('.product-select');
    let qty = parseInt(item.querySelector('.quantity-input').value) || 0;
    let price = parseFloat(select.selectedOptions[0]?.dataset.price) || 0;
    item.querySelector('.price-input').value = price.toLocaleString();
    item.querySelector('.total-input').value = (price * qty).toLocaleString();
}

function updateGrandTotal(){
    let total = 0;
    document.querySelectorAll('.item').forEach(item=>{
        let itemTotal = parseFloat(item.querySelector('.total-input').value.replace(/,/g,'')) || 0;
        total += itemTotal;
    });
    document.getElementById('grand-total').innerText = total.toLocaleString() + ' UZS';
}

// Listen for product change
document.getElementById('items').addEventListener('change', function(e){
    if(e.target.classList.contains('product-select')){
        updateItem(e.target.closest('.item'));
        updateGrandTotal();
    }
});

// Listen for quantity input (real-time)
document.getElementById('items').addEventListener('input', function(e){
    if(e.target.classList.contains('quantity-input')){
        updateItem(e.target.closest('.item'));
        updateGrandTotal();
    }
});

document.getElementById('add-item').addEventListener('click', function(){
    let container = document.getElementById('items');
    let first = container.querySelector('.item');
    let clone = first.cloneNode(true);
    clone.querySelector('.product-select').value = '';
    clone.querySelector('.quantity-input').value = 1;
    clone.querySelector('.price-input').value = '';
    clone.querySelector('.total-input').value = '';
    container.appendChild(clone);
});

document.getElementById('items').addEventListener('click', function(e){
    if(e.target.classList.contains('remove-item')){
        let items = document.querySelectorAll('.item');
        if(items.length > 1){
            e.target.closest('.item').remove();
            updateGrandTotal();
        }
    }
});

// Initialize first item
document.querySelectorAll('.item').forEach(item=>{
    updateItem(item);
});
updateGrandTotal();
</script>

{% endblock %}
